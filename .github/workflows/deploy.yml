# ============================================================
# GitHub Actions CI/CD Pipeline
# Automatically deploys to EC2 on every push to main branch
# ============================================================

name: Deploy to EC2

# --------------------------------
# Trigger — when does this run?
# Every time code is pushed to the main branch
# --------------------------------
on:
  push:
    branches:
      - main

jobs:
  deploy:
    # Run on GitHub's Ubuntu servers
    runs-on: ubuntu-latest

    steps:
      # --------------------------------
      # Step 1 — Check out the code
      # GitHub Actions needs to see your code
      # --------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # --------------------------------
      # Step 2 — SSH into EC2 and deploy
      # Uses the secrets we added to GitHub
      # --------------------------------
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Go to project folder
            cd ${{ secrets.EC2_PROJECT_PATH }}

            # Pull latest code from GitHub
            git pull origin main

            # Rebuild and restart containers
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build

            # Clear Laravel cache
            docker compose exec -T app php artisan config:clear
            docker compose exec -T app php artisan cache:clear

            # Run any new migrations
            docker compose exec -T app php artisan migrate --force

            echo "✅ Deployment complete!"